<properties
   pageTitle="流量管理器终结点监视和故障转移 | Azure"
   description="本文有助于你了解，流量管理器如何通过终结点监视和终结点自动故障转移来帮助 Azure 客户部署高可用性应用程序。"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags
	ms.service="traffic-manager"
	ms.date="07/01/2016"
	wacn.date="08/23/2016"/>

# 流量管理器终结点监视和故障转移

Azure 流量管理器包括内置的终结点监视和终结点自动故障转移功能。此功能可以让你更好地交付高可用性应用程序，以便应对终结点故障（包括 Azure 区域故障）。

流量管理器工作时，会向每个终结点定期发出请求，然后对响应进行验证。如果某个终结点无法提供有效响应，流量管理器会将其状态显示为“已降级”。该终结点将不再包括在 DNS 响应中，后者会返回一个替代的可用终结点。这种方式可以引导用户流量避开发生故障的终结点，转向可用的终结点。

针对已降级终结点的终结点运行状况检查会持续进行，因此，在这些终结点恢复且运行状况正常以后，系统会自动让其重新排队以供轮流使用。

## 配置终结点监视

若要配置终结点监视，必须在流量管理器配置文件中指定以下设置：

- **协议**。选择 HTTP 或 HTTPS。请务必注意，HTTPS 监视并不验证 SSL 证书是否有效，它只检查是否有证书。
- **端口**。选择用于请求的端口。选项包括标准 HTTP 和 HTTPS 端口。
- **路径**。指定监视运行状况检查将要尝试访问的网页或文件的相对路径和名称。请注意，正斜杠 (/) 是有效的相对路径条目，表示文件位于根目录（默认位置）中。

为了检查每个终结点的运行状况，流量管理器会使用给定的协议、端口和相对路径向终结点发出 GET 请求。

常见的做法是在应用程序中实现一个自定义页面，例如 /health.aspx。将该页配置为流量管理器终结点监视路径。在该页中，你可以在返回 HTTP 200（如果服务运行状况正常）或其他状态代码（如果属于其他情况）之前执行任何必需的且特定于应用程序的检查，例如检查数据库的可用性。

终结点监视设置在流量管理器配置文件级别配置，而不是按终结点进行配置。因此，可以使用相同的设置来检查所有终结点的运行状况。若需对不同终结点使用不同的监视设置，则可使用[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/#example-5-per-endpoint-monitoring-settings)。

## <a name="endpoint-and-profile-status"></a> 终结点和配置文件状态

你可以启用和禁用流量管理器配置文件和终结点。不过，也可以通过流量管理器的自动设置和过程来更改终结点状态。以下参数对此方法的原理进行了说明。

### 终结点状态

终结点状态是由用户控制的设置，你可以通过它来轻松启用或禁用特定终结点。此参数不影响基础服务（可能仍在运行）的状态，而是控制从流量管理器角度来看属于特定终结点的终结点的可用性。当某个终结点的状态为“已禁用”时，流量管理器不会检查其运行状况，该终结点不会包括在 DNS 响应中。

### 配置文件状态

配置文件状态是由用户控制的设置。你可以通过此参数轻松启用或禁用配置文件。终结点状态影响单个终结点，而配置文件状态则影响整个配置文件（包括所有终结点）。配置文件中状态为“已禁用”的终结点将不进行运行状况检查，在 DNS 响应中也不包括终结点（将返回 NXDOMAIN 响应）。

### 终结点监视器状态

终结点监视器状态是流量管理器生成的设置，显示终结点的当前状态。不能手动更改此设置。终结点监视器状态反映了当前正在进行的终结点监视操作，此外还有其他信息，例如终结点状态。终结点监视器状态的可能值如下表所示。（如需详细了解如何针对嵌套式终结点来计算终结点监视器状态，请参阅[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/)。）

|配置文件状态|终结点状态|终结点监视器状态（API 和门户）|说明|
|---|---|---|---|
|已禁用|已启用|非活动|配置文件已被用户禁用。虽然终结点状态仍可能是“已启用”，但配置文件状态（“已禁用”）优先。不会监视已禁用配置文件中的终结点，不会在 DNS 响应中包括终结点（将返回 NXDOMAIN 响应）。|
|&lt;任意&gt;|已禁用|已禁用|终结点已被用户禁用。不会监视“已禁用”状态的终结点。该终结点不会包括在 DNS 响应中，因此也不会接收流量。|
|已启用|已启用|联机|终结点受到监视，处于正常状态。该终结点会包括在 DNS 响应中，因此可以接收流量。|
|已启用|已启用|已降级|监视运行状况检查的终结点将要发生故障。该终结点不会包括在 DNS 响应中，因此也不会接收流量。|
|已启用|已启用|正在检查终结点|终结点受到监视，但是，尚未收到首个探测的结果。如果刚刚向配置文件添加了新的终结点，或者刚刚启用了终结点或配置文件，则此状态为常见的临时状态。此状态的终结点会包括在 DNS 响应中，因此可以接收流量。|
|已启用|已启用|已停止|终结点指向的云服务或 Web 应用未运行。检查云服务或 Web 应用设置。不会监视“已停止”状态的终结点。该终结点不会包括在 DNS 响应中，因此也不会接收流量。|

### 配置文件监视器状态

配置文件监视器状态是配置文件中所有终结点的终结点监视器状态值与已配置的配置文件状态相组合的结果。可能的值如下表所述。

|配置文件状态（已配置）|终结点监视器状态|配置文件监视器状态（API 和门户）|说明|
|---|---|---|---|
|已禁用|&lt;任意&gt; 或包含未定义终结点的配置文件。|已禁用|配置文件已被用户禁用。|
|已启用|至少一个终结点的状态为“已降级”。|已降级|这是一个指明需要客户操作的标志。查看各终结点状态值，确定哪些终结点需要进一步的关注。|
|已启用|至少一个终结点的状态为“联机”。没有任何终结点的状态为“已降级”。|联机|该服务正在接受流量，不需要客户操作。|
|已启用|至少一个终结点的状态为“正在检查终结点”。没有任何终结点为“联机”或“已降级”状态。|正在检查终结点|过渡状态。这通常在刚创建或启用配置文件并且正在首次检查终结点运行状况时发生。|
|已启用|配置文件中定义的所有终结点的状态为“已禁用”或“已停止”，或者配置文件中没有定义终结点。|非活动|没有任何终结点处于活动状态，但是配置文件的状态仍旧是“已启用”。|

## 终结点故障转移和故障回复

考虑一下这样一种场景：以前运行状况正常的终结点发生故障。流量管理器检测到了该故障，于是从轮转列表中删除了该终结点。该终结点随后恢复。流量管理器检测到了该恢复，于是该终结点又回到了轮转列表中。

>[AZURE.NOTE] 只有当返回消息为“200 正常”时，流量管理器才会认为终结点处于联机状态。如果出现以下任何情况，流量管理器会认为终结点运行状况检查失败：

>- 收到非 200 响应（包括其他 2xx 代码，或者 301/302 重定向）
>- 客户端身份验证请求
>- 超时（超时阈值为 10 秒）
>- 无法连接

>有关对失败的检查进行故障排除的详细信息，请参阅 [Azure 流量管理器上的降级状态故障排除](/documentation/articles/traffic-manager-troubleshooting-degraded/)。

以下时间线详细描述了相关步骤。

![流量管理器终结点故障转移和故障回复顺序](./media/traffic-manager-monitoring/timeline.png)

1. **GET**。流量管理器监视系统对你在监视设置中指定的路径和文件执行 GET 请求。每个终结点都会重复此操作。
2. **200 正常**。监视系统预期在 10 秒内会返回一条“HTTP 200 正常”消息。如果收到该响应，该系统会认为云服务可用。
3. **间隔 30 秒进行检查**。终结点运行状况检查将每隔 30 秒重复一次。
4. **服务不可用**。该服务变得不可用。在下次执行运行状况检查前，流量管理器不会知道该服务是否可用。
5. **尝试访问监视文件（四次尝试）**。监视系统执行了 GET 请求，但没有在 10 秒的超时期间内收到响应（也可能收到的是非 200 响应）。然后它又尝试了三次，每隔 30 秒一次。如果其中一次尝试成功，尝试次数就会重置。
6. **状态设置为“已降级”**。第四次连续失败后，监视系统将不可用终结点的状态标记为“已降级”。
7. **流量转移到其他终结点**。流量管理器 DNS 名称服务器进行更新，流量管理器不再返回终结点来响应 DNS 查询。新连接将定向到其他可用终结点。不过，包含此终结点的 DNS 响应可能仍由递归 DNS 服务器和 DNS 客户端缓存。这会导致某些客户端尝试连接到此终结点。这些缓存到期以后，客户端在进行新的 DNS 查询时会被引导到其他终结点。缓存持续时间由流量管理器配置文件中的 TTL 设置控制，例如，可以将其设置为 30 秒。
8. **继续进行运行状况检查**。在终结点的状态为“已降级”后，流量管理器会继续检查该终结点的运行状况。之所以这样做，是因为这样做可以检测该终结点何时恢复正常运行状况。
9. **服务重新联机**。该服务变得可用。终结点会在流量管理器中始终保持“已降级”状态，直至监视系统执行下一次运行状况检查。
10. **到服务的流量恢复**。流量管理器发送 GET 请求，然后收到“200 正常”状态响应。这表示服务已回到正常状态。流量管理器名称服务器进行更新，并开始在 DNS 响应中分发服务的 DNS 名称。当缓存的 DNS 响应（返回其他终结点）到期时，以及现有的到其他终结点的连接终止时，流量将返回到该终结点。

>[AZURE.NOTE] 由于流量管理器是在 DNS 级别工作的，因此不可能影响任何终结点的现有连接。在终结点之间引导流量时（不管是通过更改配置文件设置来进行，还是在故障转移或故障回复期间进行），流量管理器都会将新连接引导到可用的终结点。不过，其他终结点可能仍会通过现有连接继续接收流量，直至相关会话被终止。若要耗尽现有连接的流量，应通过应用程序来限制适用于每个终结点的会话持续时间。

## 降级的终结点

当某个终结点的状态为“已降级”时，将不再返回该终结点来响应 DNS 查询（此规则存在例外，具体请参阅本部分结尾的说明），而是选择一个替代终结点并将其返回。替代终结点的选择取决于所配置的流量路由方法：

- **优先级**。终结点构成一个采用优先级的列表。将始终返回列表中第一个可用的终结点。如果终结点状态为“已降级”，则返回下一个可用的终结点。
- **加权**。可能会返回任何可用的终结点，系统会根据分配给这些终结点的权重以及其他可用终结点的权重随机进行选择。如果终结点状态为“已降级”，则会从包含可用终结点的剩余池中选择终结点。
- **性能**。将返回最靠近最终用户的终结点（状态为“已禁用”或“已停止”的终结点除外）。如果该终结点不可用，则会从所有其他可用的终结点中随机选择返回的终结点。（这有助于避免当下一个最靠近的终结点过载时可能发生的级联失败。你可以使用[嵌套式流量管理器配置文件](/documentation/articles/traffic-manager-nested-profiles/#example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region)针对“性能”流量路由来配置替代的故障转移计划。）

有关详细信息，请参阅[流量管理器流量路由方法](/documentation/articles/traffic-manager-routing-methods/)。

>[AZURE.NOTE] 如果所有流量管理器终结点（状态为“已禁用”或“已停止”的终结点除外）都没有通过运行状况检查，从而显示“已降级”状态，则会发生什么情况？

>引发这种现象的最常见原因是服务配置错误（例如访问控制列表 [ACL] 阻止了流量管理器运行状况检查），或者是流量管理器配置文件配置错误（例如监视路径不正确）。

>在本示例中，流量管理器“尽最大努力”进行了尝试，其响应就好像所有处于“已降级”状态的终结点实际上处于联机状态一样。这要优于替代方法，后者不会在 DNS 响应中返回任何终结点。

>此行为的一个结果是，即使流量管理器运行状况检查没有正确进行配置，但从流量路由的角度来看，流量管理器似乎也是正常运行的。但在本示例中，终结点发生故障时不会进行终结点故障转移，这会影响应用程序的总体可用性。若要确保不发生这种情况，必须确保配置文件显示“联机”状态而非“已降级”状态。状态为“联机”表示流量管理器运行状况检查可以正常进行。

有关对失败的运行状况检查进行故障排除的更多详细信息，请参阅 [Azure 流量管理器上的降级状态故障排除](/documentation/articles/traffic-manager-troubleshooting-degraded/)。

## 常见问题

### 流量管理器本身能否应对 Azure 区域故障？

流量管理器可提供内置的运行状况检查并可自动在区域之间进行故障转移，因此在 Azure 的高可用性应用程序（包括可以应对区域性 Azure 服务中断的应用程序）交付方面发挥重要作用。

因此，流量管理器本身必须提供程度很高的可用性，包括能够应对区域性故障。

虽然流量管理器的某些部分在 Azure 中运行，但这些组件是跨区域分布的，而且根据设计可以应对任何 Azure 区域所发生的完全故障。这样的应对能力见于所有流量管理器组件：DNS 名称服务器、API、存储层、终结点监视服务。

因此，即使整个 Azure 区域的服务完全中断（不太可能发生），流量管理器也会继续正常运行，应用程序部署在多个 Azure 区域的客户可以依赖流量管理器将流量引导到可用的应用程序实例。

### 选择资源组位置会如何影响流量管理器？

流量管理器属于单一的全局性服务，而不是区域性服务。选择资源组位置对部署在该资源组中的流量管理器配置文件没有影响。

Azure Resource Manager 要求所有资源组指定一个位置，这决定了部署在该资源组中的资源的默认位置。通过 Azure 门户创建流量管理器配置文件时，如果你创建一个新的资源组，系统会要求你提供该位置。

所有流量管理器都使用“全局”作为其位置。由于这是可以接受的唯一值，因此在 Azure 门户、PowerShell 或 Azure CLI 中无法访问此设置。这将覆盖资源组默认值。

### 如何确定每个终结点的当前运行状况？

除了总体配置文件，每个终结点的当前监视状态也显示在 Azure 门户中。该信息也可通过流量监视器 [REST API](https://msdn.microsoft.com/zh-cn/library/azure/mt163667.aspx)、[PowerShell cmdlet](https://msdn.microsoft.com/zh-cn/library/mt125941.aspx) 和[跨平台 Azure CLI](/documentation/articles/xplat-cli-install/) 获取。

不能查看有关过去的终结点运行状况的历史信息，也不能配置有关终结点运行状况更改的警报。

### 能否监视 HTTPS 终结点？

是的。流量管理器支持通过 HTTPS 进行探测。直接在监视配置中将 **HTTPS** 配置为协议。
请注意：

- 不验证服务器端证书
- 不支持 SNI 服务器端证书
- 不支持客户端证书

### 终结点运行状况检查使用什么主机头？

在 HTTP 和 HTTPS 运行状况检查中使用的主机头是与每个终结点关联的 DNS 名称。该主机头在 Azure 门户、[PowerShell cmdlet](https://msdn.microsoft.com/zh-cn/library/mt125941.aspx)、[跨平台 Azure CLI](/documentation/articles/xplat-cli-install/) 和 [REST API](https://msdn.microsoft.com/zh-cn/library/azure/mt163667.aspx) 中被公开为终结点目标。

该值是终结点配置的一部分。在主机头中使用的值不能通过目标属性单独指定。


## 后续步骤

了解[流量管理器工作原理](/documentation/articles/traffic-manager-how-traffic-manager-works/)

详细了解流量管理器支持的[流量路由方法](/documentation/articles/traffic-manager-routing-methods/)

了解如何[创建流量管理器配置文件](/documentation/articles/traffic-manager-manage-profiles/)

流量管理器终结点上的[降级状态故障排除](/documentation/articles/traffic-manager-troubleshooting-degraded/)

<!---HONumber=Mooncake_0627_2016-->